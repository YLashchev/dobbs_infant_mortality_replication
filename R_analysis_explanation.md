# Understanding the R Analysis: `plot_utilities.R` and `mortality_paper_figures.qmd`

This document explains how the R script `plot_utilities.R` and the Quarto Markdown document `mortality_paper_figures.qmd` work together to perform data analysis, generate visualizations, and create tables.

## `mortality_paper_figures.qmd` (Quarto Markdown Document)

This is the primary document that orchestrates the entire analysis workflow. It's a Quarto Markdown file, which means it can embed and execute R code directly. When rendered (e.g., to HTML), the R code runs, and its output (plots, tables, text) is seamlessly integrated into the final document.

### Key Sections and Their Roles:

*   **YAML Header:** Defines the document's metadata, such as the title, author, and output format. Options like `code-fold: true` allow for interactive documents where users can hide or show the underlying R code.
*   **`packages` R Chunk:**
    *   Loads essential R libraries required for the analysis. These include:
        *   `tidyverse`: A collection of R packages (like `dplyr` for data manipulation and `ggplot2` for plotting) that provide powerful tools for data science.
        *   `tidybayes`: Specifically designed for working with Bayesian model outputs, making it easier to extract and visualize posterior distributions.
        *   `posterior`: Another package for working with posterior samples from Bayesian models.
        *   `jsonlite`: For working with JSON data.
        *   `kableExtra` and `gt`: Used for creating highly customizable and visually appealing tables.
    *   Sets up global variables like `suffix` and `fig_suffix`, which are used for consistent naming of output files.
*   **Data Loading and Preprocessing:**
    *   Reads the main dataset (`df`) and aggregation data (`aggregations`) from CSV files.
    *   Performs crucial data cleaning steps, including:
        *   Converting date columns to a proper date format.
        *   Filtering data to include only relevant time periods (e.g., from 2012 onwards).
        *   Includes a `fill_in_missing_denoms` function (defined directly within this QMD file) to handle missing population data through imputation.
        *   Applies various `dplyr` operations (e.g., `mutate`, `group_by`, `summarize`, `pivot_longer`) to transform and aggregate the data into formats suitable for subsequent analysis, such as `agg_births`, `agg_deaths`, and `agg_df_total` for absolute and relative mortality rates.
*   **`load_data` R Chunk:**
    *   **Crucially, this section sources `plot_utilities.R` using `source("plot_utilities.R")`.** This command executes the R script, making all the functions defined within `plot_utilities.R` available for use in `mortality_paper_figures.qmd`.
    *   Loads the output from the Python Bayesian model (CSV files like `Poisson_mortality_...csv`) into R. These files contain the MCMC samples (posterior draws) from the model.
    *   Utilizes the `merge_draws_and_data` function (from `plot_utilities.R`) to combine the raw data (`df`) with the MCMC samples (`type_samples`). This step is vital as it prepares the data in a "tidy" format, which is a prerequisite for most plotting and table-generating functions.
    *   Further data manipulation is performed to create specific data subsets like `df_ban_no_tx`, `df_all_ban`, and `df_unexposed`, representing different state groupings (e.g., states with abortion bans excluding Texas, all states with bans, unexposed states).
    *   Finally, `quantiles_df` is generated by summarizing the `all_samples` data. This dataframe contains mean predicted values and their credible intervals, which are directly used by the plotting functions.
*   **Plotting and Table Generation R Chunks (e.g., `Fit and Gap Plots`, `Interval Plots`, `Table`, `States Table`, `PPC Figures`, `Event-Time Gap Plot`):**
    *   These sections are where the functions from `plot_utilities.R` are called.
    *   They pass the prepared dataframes (`merged_df`, `quantiles_df`) and specific parameters (e.g., `state_name`, `category`, `target` variable like "deaths" or "births") to the functions.
    *   The generated plots are saved as image files (e.g., PNG) using `ggsave`, and tables are saved using `gtsave`.
*   **`Aggregation Computations for Paper` R Chunk:**
    *   Performs additional statistical analyses, such as correlation tests and variance decomposition.
    *   Writes summary statistics and findings to a text file (`summaries_for_paper.txt`).

## `plot_utilities.R` (R Script with Helper Functions)

This script is a library of reusable R functions. It encapsulates the logic for common data processing, visualization, and reporting tasks, making the `mortality_paper_figures.qmd` cleaner and more modular.

### Key Functions and Their Roles:

*   **`merge_draws_and_data(dat, samples, ...)`:**
    *   **Purpose:** This is a fundamental data preparation function. It takes the raw input data (`dat`) and the MCMC samples (`samples`) from the Bayesian model.
    *   **Functionality:** It reshapes the data, merges it with the posterior draws, and calculates predicted values (`ypred`). It also handles different categories (e.g., "race", "total") and aggregates data for specific state groupings (e.g., "Ban States", "Unexposed States"). This function is crucial for transforming the raw model output into a "tidy" format that can be easily used by `ggplot2` and other visualization tools.
*   **`make_all_te_plots(...)`:**
    *   **Purpose:** A convenience wrapper function that combines several individual plotting functions (`make_state_fit_plot`, `make_gap_plot`, `make_births_histogram`) into a single output.
*   **`make_state_fit_plot(quantiles_df, state_name, category, target)`:**
    *   **Purpose:** Visualizes how well the Bayesian model fits the observed data.
    *   **Functionality:** Generates a line plot showing observed data points, the mean predicted values from the model, and their credible intervals (uncertainty range) over time for a specific state and category.
*   **`make_gap_plot(quantiles_df, state_name, category, target)`:**
    *   **Purpose:** Highlights the estimated causal effect of an intervention (e.g., abortion ban).
    *   **Functionality:** Creates a plot showing the difference or ratio between the observed values and the model's predicted counterfactual values (what would have happened without the intervention) over time.
*   **`make_births_histogram(merged_df, state_name, category, treatment_date, target)`:**
    *   **Purpose:** Assesses the distribution of the difference between observed and predicted outcomes.
    *   **Functionality:** Generates a histogram of the difference between observed and predicted total births (or deaths) for a given state and category, often including a p-value to indicate statistical significance.
*   **`make_violins(merged_df, states, treatment_date, group_var, categories, target, denom, ...)`:**
    *   **Purpose:** Visualizes the distribution of estimated causal effects across different groups (e.g., states, categories).
    *   **Functionality:** Creates violin plots that show the density distribution of the causal effect (either as a difference or a ratio) for various states or categories. It calculates treated and untreated rates based on the model's output.
*   **`make_interval_plot(merged_df, states, treatment_date, group_var, categories, target, denom, ...)`:**
    *   **Purpose:** Presents point estimates and credible intervals for causal effects.
    *   **Functionality:** Similar to `make_violins`, but uses `ggdist::stat_pointinterval` to display the median estimate and various credible intervals (e.g., 67% and 95%) for the causal effect, often used for comparing effects across multiple groups or categories.
*   **`make_table(...)` and `make_mortality_table(...)`:**
    *   **Purpose:** Generates highly formatted and informative tables summarizing the model's quantitative results.
    *   **Functionality:** These functions use the `gt` package to create tables that include observed counts, expected differences, and rate changes, along with their credible intervals and associated p-values. They can aggregate results for specific states or groups of states.
*   **Posterior Predictive Check (PPC) Functions (`make_acf_ppc_plot`, `make_rmse_ppc_plot`, `make_abs_res_ppc_plot`, `make_sign_change_ppc_plot`, `make_unit_corr_ppc_plot`):**
    *   **Purpose:** These functions are critical for evaluating the adequacy and fit of the Bayesian model.
    *   **Functionality:** They compare various statistical properties of the observed data (e.g., autocorrelation of residuals, Root Mean Squared Error (RMSE), maximum absolute residual, number of sign changes in residuals, correlations between units) with those generated from the model's posterior predictions. This helps determine if the model captures the underlying data generating process well.
*   **Factor Analysis Functions (`get_factor_arrays`, `make_latent_factors_plot`, `make_factor_loadings_plot`):**
    *   **Purpose:** Used for visualizing the latent factors and their loadings from the Non-negative Matrix Factorization (NMF) component of the model.
    *   **Functionality:** These functions help interpret the underlying structure learned by the model, showing how different time periods and states contribute to the observed patterns.

## How They Work Together: The Workflow

1.  **Initialization (`mortality_paper_figures.qmd`):** The Quarto document starts by loading necessary R packages and the raw input data.
2.  **Function Availability (`mortality_paper_figures.qmd`):** It then executes `source("plot_utilities.R")`, which loads all the helper functions into the R environment, making them accessible.
3.  **Model Output Integration (`mortality_paper_figures.qmd`):** The QMD reads the MCMC samples (posterior draws) that were generated by the Python `run_model.py` script.
4.  **Data Preparation (`mortality_paper_figures.qmd` calls `plot_utilities.R`):** The `merge_draws_and_data` function (from `plot_utilities.R`) is called to combine the raw data with the model's posterior samples. This step is crucial for transforming the data into a format that can be directly used for plotting and table generation.
5.  **Analysis and Visualization (`mortality_paper_figures.qmd` calls `plot_utilities.R`):** The QMD then iteratively calls various plotting and table-generating functions (e.g., `make_state_fit_plot`, `make_interval_plot`, `make_mortality_table`) from `plot_utilities.R`. It passes the prepared dataframes and specific parameters to these functions.
6.  **Output Generation (`plot_utilities.R` functions save results):** The functions in `plot_utilities.R` generate the desired plots (using `ggplot2`) and tables (using `gt`) and save them to specified output directories (e.g., `figs/main_figures/`).

In summary, `plot_utilities.R` provides a modular and reusable set of tools for data processing, visualization, and reporting, while `mortality_paper_figures.qmd` acts as the main script that orchestrates the entire analysis pipeline, using these tools to generate a comprehensive report on the effects of abortion bans.
